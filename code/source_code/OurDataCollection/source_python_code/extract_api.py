import sys
import os
import csv

sys.path.append("/content/drive/MyDrive/HK2_2023-2024/NT230/Tools/pe_parser/pe_parser")
from pe_parser.asm_parser import AssemblyParser

asm_dir = '/content/drive/MyDrive/HK2_2023-2024/NT230/demo_malware/sample/ShadowPadAPTbackdoor/malware_sample/asm'
files = [f for f in os.listdir("/content/drive/MyDrive/HK2_2023-2024/NT230/demo_malware/sample/ShadowPadAPTbackdoor/malware_sample/asm") if f.endswith(".asm")]
with open("/content/drive/MyDrive/HK2_2023-2024/NT230/Tools/pe_parser/pe_parser/vocabulary/subset_APIs.txt", "r") as file:
    lines = file.readlines()

api_calls = [api.replace("\n", "") for api in lines]

with open("/content/drive/MyDrive/HK2_2023-2024/NT230/demo_malware/process_data/demo/demo_backdoor_apt_api_call.csv", "w", newline='') as csv_file:
  writer = csv.writer(csv_file)
  writer.writerow(['Id'] + api_calls)

  for file_name in files:


    asm_parser = AssemblyParser(os.path.join(asm_dir, file_name))

    api_features = asm_parser.extract_API_features()

    api_call = [api[1] for api in list(api_features.items())]
    api_list = []
    for api in api_call:
      if api > 0:
        api_list.append(1)
      else:
        api_list.append(0)

    writer.writerow([file_name.split('.')[0]] + api_list)