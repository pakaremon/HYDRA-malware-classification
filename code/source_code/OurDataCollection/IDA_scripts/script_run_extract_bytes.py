
import os
from os import path
import subprocess
from os.path import isfile
IDA_PATH32 = "idaq.exe"
IDA_PATH64 = "idaq64.exe"
IDA_PLUGIN = "C:\\Users\\nguye\\Desktop\\NT230\\malware\\IDB\\extract_bytes_ida_plugin.py"

directory = 'C:\\Users\\nguye\\Desktop\\NT230\\malware\\2020.10.26.Drweb-ShadowPad_APT_backdoor_PlugX\\2020.10.26.Drweb-ShadowPad_APT_backdoor_PlugX'
IDB_DIR = "C:\\Users\\nguye\\Desktop\\NT230\\malware\\IDB\\dataBaseIDB"

def export_byte_64(idb_path, file_name):  
    if  isfile(idb_path):       
        cmd = [IDA_PATH64,
                '-A',
                # '-L{}'.format(LOG_PATH),
                '-S{}'.format(IDA_PLUGIN),
                '-Ofile_name:{}'.format(file_name),
                idb_path]

        print("[D] cmd: {}".format(cmd))

        proc = subprocess.Popen(
            cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = proc.communicate()

        if proc.returncode == 0:
            print("[D] {}: success".format(idb_path))
        else:
            print("[!] Error in {} (returncode={})".format(
                idb_path, proc.returncode))
    else:
        print("[!] Error: {} does not exist".format(idb_path))

# Get a list of all files and directories in the specified directory
all_files = os.listdir(directory)

# Filter out only the files (not directories)
files = [ f for f in all_files if os.path.isfile(os.path.join(directory, f))]

for file in files:
    input_idb = path.join(IDB_DIR, file + ".i64")
    export_byte_64(input_idb, file)

